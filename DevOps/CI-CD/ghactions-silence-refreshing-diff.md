# Silence "Refreshing stateâ€¦" & Highlight Changes in Github Actions Terraform Plan Output

_Last updated: November 12, 2022_

![ghactions-tfplan-refreshstate](/images/ghactions-tfplan-refreshstate.png)

## Purpose
After working with Github Actions as my Terraform CI pipeline over the past year, I started looking for potential methods to cleaning up the  Plan outputs in order to provide a more streamlined PR review. Initially, I was interested in finding a way to redact all of the "Refreshing state..." messages from the plan output as I find it distracting and unnecessary for the reviewer. These messages can also get quite lengthy for larger infrastructure containing many cloud resources. 

Essentially what Terraform is doing while generating these messages is ensuring that your state files are in alignment with the existing cloud infrastructure - while I understand why they're generated and necessary, they just aren't needed in the PR review process. I also discovered that you can incorporate the `diff` utility into your Actions script section to provide color highlights in the output of your Plan changes so this runbook will cover the lines of coded needed for this to display correctly.

I'll only be discussing the GH Actions jobs for Terraform plan, show, reformatting the plan, creating the plan environment variable and incorporating this into the script section of the pull-request plan output. 

Example code snippets will be taken from my workflow on Github [here](https://github.com/jksprattler/azure-security/blob/main/.github/workflows/azuretfdeploy.yml)

The PR I used for testing the config can be reviewed [here](https://github.com/jksprattler/azure-security/pull/8)

## Github Actions Config
1. In the Terraform Plan job ensure that the `-no-color` flag is set as without it the output is not rendered correctly by the JavaScript and you'll see garbled text/characters. Apply the `-out` flag which saves the plan output to a local file and assign it a name:
```scss
      - name: "Terraform Plan"
        id: plan
        run: terraform plan -detailed-exitcode -no-color -out=plan -input=false
        continue-on-error: true
```
2. Create a job for the Terraform Show output. This is going to read the local file of the plan saved in the previous step. Running this job is what will redact all of the "Refreshing state..." messages which get generated by the original terraform plan. Set an if condition to only run the show job when the plan has succeeded or provided exit codes 0 (no changes) or 2 (changes present) and write the contents to a text file:
```scss
      - name: Terraform Show 
        id: show 
        if: steps.plan.outcome == 'success' || steps.plan.outputs.exitcode == '0' || steps.plan.outputs.exitcode == '2'
        run: terraform show -no-color plan > plan.txt
        continue-on-error: true
```
3. Create a job to Reformat the plan contents of the text file and write it to a new formatted text file. This will render the plan output in a way that the `diff` utility recognizes changes within the file as its read during the pull-request script workflow. The sed command in the job uses a Regex statement to apply spaces in front of any symbols next to resource actions by pushing them to the first column of the output. This is required in order for the `diff` utility to correctly render the output into color highlights for changes.
```scss
      - name: Reformat Plan 
        run: |
          cat plan.txt | sed -E 's/^([[:space:]]+)([-+~])/\2\1/g' > format_plan.txt
        continue-on-error: true
```
4. Create a job to assign the new formatted plan output to a Github Environment variable in order to call the var from within the pull-request script. Note the line containing `"${PLAN:0:65536}"` which is required for very large plan output as the Github database sets a limit of 65536 characters on comments. Without setting this limit, if you were to submit a PR over the limit the entire pipeline would fail. However, with this setting applied a very large plan would be cut off so the reviewer would have to navigate to the Actions tab of the repo and analyze the Terraform Plan job contents.
```scss
      - name: Put Plan in Env Var
        run: |
          PLAN=$(cat format_plan.txt)
          echo "PLAN<<EOF" >> $GITHUB_ENV
          echo "${PLAN:0:65536}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV     
```
5. Update the pull-request script with the `diff` utility and the new Plan environment variable:
```scss
            <details><summary>Show Plan</summary>
      
            \`\`\`\diff\n
            ${{ env.PLAN }}
            \`\`\`
      
            </details>
````
## Conclusion
With all of the Terraform jobs discussed above in place, the CI pipeline for the PR comments no longer display the "Refreshing state..." messages, have color highlights for all the changes and are overall much cleaner  output for the reviewer:

![ghactions-tfplan-norefreshstate](/images/ghactions-tfplan-norefreshstate.png)
